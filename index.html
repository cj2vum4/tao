<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地址路線規劃系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide React Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- 錯誤處理和調試 -->
    <script>
        // 全域錯誤處理
        window.addEventListener('error', function(e) {
            console.error('全域錯誤:', e.error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 8px; margin: 20px;">
                    <h2 style="color: #c33;">載入錯誤</h2>
                    <p>錯誤訊息: ${e.error.message}</p>
                    <p>請檢查瀏覽器控制台以獲取更多詳細資訊。</p>
                </div>
            `;
        });
        
        // 檢查依賴是否載入
        window.addEventListener('load', function() {
            console.log('頁面載入完成');
            console.log('React:', typeof React);
            console.log('ReactDOM:', typeof ReactDOM);
            console.log('Babel:', typeof Babel);
            console.log('Lucide:', typeof lucide);
            console.log('PapaParse:', typeof Papa);
        });
    </script>
    
    <!-- PapaParse for CSV parsing -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* 自定義樣式 */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 確保滾動條樣式 */
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div style="text-align: center; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                <div style="width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <h2 style="color: #333; margin-bottom: 10px;">載入地址路線規劃系統中...</h2>
                <p style="color: #666; margin: 0;">正在初始化應用程式</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 簡單的圖標組件
        const MapPin = (props) => React.createElement('svg', {
          ...props,
          width: 24,
          height: 24,
          viewBox: '0 0 24 24',
          fill: 'none',
          stroke: 'currentColor',
          strokeWidth: 2,
          strokeLinecap: 'round',
          strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z' }), React.createElement('circle', { cx: 12, cy: 10, r: 3 }));
        
        const Calendar = (props) => React.createElement('svg', {
          ...props,
          width: 24,
          height: 24,
          viewBox: '0 0 24 24',
          fill: 'none',
          stroke: 'currentColor',
          strokeWidth: 2,
          strokeLinecap: 'round',
          strokeLinejoin: 'round'
        }, React.createElement('rect', { x: 3, y: 4, width: 18, height: 18, rx: 2, ry: 2 }), React.createElement('line', { x1: 16, y1: 2, x2: 16, y2: 6 }), React.createElement('line', { x1: 8, y1: 2, x2: 8, y2: 6 }), React.createElement('line', { x1: 3, y1: 10, x2: 21, y2: 10 }));
        
        const List = (props) => React.createElement('svg', {
          ...props,
          width: 24,
          height: 24,
          viewBox: '0 0 24 24',
          fill: 'none',
          stroke: 'currentColor',
          strokeWidth: 2,
          strokeLinecap: 'round',
          strokeLinejoin: 'round'
        }, React.createElement('line', { x1: 8, y1: 6, x2: 21, y2: 6 }), React.createElement('line', { x1: 8, y1: 12, x2: 21, y2: 12 }), React.createElement('line', { x1: 8, y1: 18, x2: 21, y2: 18 }), React.createElement('line', { x1: 3, y1: 6, x2: 3.01, y2: 6 }), React.createElement('line', { x1: 3, y1: 12, x2: 3.01, y2: 12 }), React.createElement('line', { x1: 3, y1: 18, x2: 3.01, y2: 18 }));
        
        const BarChart3 = (props) => React.createElement('svg', {
          ...props,
          width: 24,
          height: 24,
          viewBox: '0 0 24 24',
          fill: 'none',
          stroke: 'currentColor',
          strokeWidth: 2,
          strokeLinecap: 'round',
          strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M3 3v18h18' }), React.createElement('path', { d: 'M18 17V9' }), React.createElement('path', { d: 'M13 17V5' }), React.createElement('path', { d: 'M8 17v-3' }));
        
        const Navigation = (props) => React.createElement('svg', {
          ...props,
          width: 24,
          height: 24,
          viewBox: '0 0 24 24',
          fill: 'none',
          stroke: 'currentColor',
          strokeWidth: 2,
          strokeLinecap: 'round',
          strokeLinejoin: 'round'
        }, React.createElement('polygon', { points: '3,11 22,2 13,21 11,13 3,11' }));
        
        const Check = (props) => React.createElement('svg', {
          ...props,
          width: 24,
          height: 24,
          viewBox: '0 0 24 24',
          fill: 'none',
          stroke: 'currentColor',
          strokeWidth: 2,
          strokeLinecap: 'round',
          strokeLinejoin: 'round'
        }, React.createElement('polyline', { points: '20,6 9,17 4,12' }));
        
        const X = (props) => React.createElement('svg', {
          ...props,
          width: 24,
          height: 24,
          viewBox: '0 0 24 24',
          fill: 'none',
          stroke: 'currentColor',
          strokeWidth: 2,
          strokeLinecap: 'round',
          strokeLinejoin: 'round'
        }, React.createElement('line', { x1: 18, y1: 6, x2: 6, y2: 18 }), React.createElement('line', { x1: 6, y1: 6, x2: 18, y2: 18 }));

        const AddressRoutePlanner = () => {
          const [allData, setAllData] = useState([]);
          const [streetData, setStreetData] = useState([]);
          const [selectedStreets, setSelectedStreets] = useState([]);
          const [routeDays, setRouteDays] = useState([]);
          const [view, setView] = useState('overview');
          const [loading, setLoading] = useState(true);
          const [loadError, setLoadError] = useState(null);

          // Google Sheets ID from the URL
          const SPREADSHEET_ID = '1hub7TaS7nnFmbiNFQ-YEBL5AyKU1-x9V';

          useEffect(() => {
            loadData();
          }, []);

          // 提取門牌號碼用於排序
          const extractHouseNumber = (address) => {
            let cleanAddr = address.replace(/[一二三四五六七八九十百]+樓/, '').replace(/\d+樓/, '');
            const houseMatch = cleanAddr.match(/(\d+)(?:之(\d+))?號/);
            if (houseMatch) {
              const main = parseInt(houseMatch[1]);
              const sub = houseMatch[2] ? parseInt(houseMatch[2]) : 0;
              return main * 1000 + sub;
            }
            return 999999;
          };

          const loadData = async () => {
            setLoading(true);
            setLoadError(null);
            
            try {
              console.log('開始從 Google Sheets 讀取資料...');
              
              // Google Sheets 的各個工作表名稱
              const sheetNames = ['新店區', '深坑區', '石碇區', '坪林區', '烏來區'];
              let allSheetData = [];

              // 逐一讀取每個工作表
              for (const sheetName of sheetNames) {
                try {
                  const gid = getSheetGID(sheetName);
                  const csvUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}`;
                  
                  console.log(`正在讀取 ${sheetName} (GID: ${gid})...`);
                  
                  const response = await fetch(csvUrl);
                  if (!response.ok) {
                    throw new Error(`無法讀取 ${sheetName}: ${response.status}`);
                  }
                  
                  const csvText = await response.text();
                  
                  // 檢查是否為有效的CSV資料
                  if (!csvText || csvText.trim().length === 0) {
                    throw new Error(`${sheetName} 回傳空資料`);
                  }
                  
                  // 使用 PapaParse 解析 CSV
                  const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                  });

                  if (parsed.errors && parsed.errors.length > 0) {
                    console.warn(`${sheetName} CSV 解析警告:`, parsed.errors);
                  }

                  const sheetData = parsed.data
                    .filter(row => row && Object.keys(row).length > 0) // 過濾空行
                    .map(row => ({
                      ...row,
                      '區域': sheetName
                    }));

                  console.log(`${sheetName}: ${sheetData.length} 筆資料`);
                  allSheetData = allSheetData.concat(sheetData);
                  
                } catch (error) {
                  console.error(`讀取 ${sheetName} 失敗:`, error);
                  // 繼續嘗試其他工作表
                }
              }

              // 如果無法從 Google Sheets 讀取資料，使用備用資料
              if (allSheetData.length === 0) {
                console.log('使用備用資料...');
                allSheetData = getFallbackData();
              }

              console.log('總資料筆數:', allSheetData.length);
              setAllData(allSheetData);

              // 建立街道資料
              const streetMap = {};
              allSheetData.forEach(row => {
                const address = row['地址'] || '';
                const match = address.match(/([^市區]+[路街巷弄])/);
                if (match) {
                  const street = match[1];
                  if (!streetMap[street]) {
                    streetMap[street] = {
                      name: street,
                      district: row['區域'],
                      count: 0,
                      addresses: []
                    };
                  }
                  streetMap[street].count++;
                  streetMap[street].addresses.push(row);
                }
              });

              // 對每條街道的地址按門牌號碼排序
              Object.values(streetMap).forEach(street => {
                street.addresses.sort((a, b) => {
                  return extractHouseNumber(a['地址']) - extractHouseNumber(b['地址']);
                });
              });

              const streets = Object.values(streetMap)
                .sort((a, b) => b.count - a.count)
                .map((s, idx) => ({ ...s, id: idx }));
              
              console.log('街道數量:', streets.length);
              setStreetData(streets);
              setLoading(false);
              console.log('✅ 資料載入完成');
              
            } catch (error) {
              console.error('載入資料錯誤:', error);
              setLoadError(error.message);
              setLoading(false);
            }
          };

          // 取得工作表的 GID
          const getSheetGID = (sheetName) => {
            // 從您的 Google Sheets URL 中取得的實際 GID
            const gidMap = {
              '新店區': '1898036359',
              '深坑區': '1059413360',
              '石碇區': '468447500', 
              '坪林區': '1135958968',
              '烏來區': '396230333'
            };
            return gidMap[sheetName] || '1898036359';
          };

          // 備用資料
          const getFallbackData = () => {
            return [
              { '姓名': '張三', '地址': '新北市新店區中正路123號', '區域': '新店區' },
              { '姓名': '李四', '地址': '新北市新店區中正路125號', '區域': '新店區' },
              { '姓名': '王五', '地址': '新北市新店區中正路127號', '區域': '新店區' },
              { '姓名': '陳六', '地址': '新北市深坑區文山路45號', '區域': '深坑區' },
              { '姓名': '林七', '地址': '新北市深坑區文山路47號', '區域': '深坑區' },
              { '姓名': '黃八', '地址': '新北市石碇區碇格路78號', '區域': '石碇區' },
              { '姓名': '劉九', '地址': '新北市坪林區坪林街12號', '區域': '坪林區' },
              { '姓名': '吳十', '地址': '新北市烏來區烏來街34號', '區域': '烏來區' }
            ];
          };

          const toggleStreet = (streetId) => {
            setSelectedStreets(prev => {
              if (prev.includes(streetId)) {
                return prev.filter(id => id !== streetId);
              } else {
                return [...prev, streetId];
              }
            });
          };

          const generateRoute = () => {
            const days = parseInt(document.getElementById('dayCount').value) || 3;
            const selected = streetData.filter(s => selectedStreets.includes(s.id));
            
            const totalAddresses = selected.reduce((sum, s) => sum + s.count, 0);
            const perDay = Math.ceil(totalAddresses / days);
            
            const routes = [];
            let currentDay = [];
            let currentCount = 0;

            selected.forEach(street => {
              if (currentCount + street.count > perDay && currentDay.length > 0) {
                routes.push(currentDay);
                currentDay = [];
                currentCount = 0;
              }
              currentDay.push(street);
              currentCount += street.count;
            });

            if (currentDay.length > 0) {
              routes.push(currentDay);
            }

            setRouteDays(routes);
            setView('route');
          };

          const getTotalSelected = () => {
            return streetData
              .filter(s => selectedStreets.includes(s.id))
              .reduce((sum, s) => sum + s.count, 0);
          };

          const getDistrictInfo = () => {
            const districtStats = {};
            const selected = streetData.filter(s => selectedStreets.includes(s.id));
            
            selected.forEach(street => {
              if (!districtStats[street.district]) {
                districtStats[street.district] = { count: 0, streets: 0 };
              }
              districtStats[street.district].count += street.count;
              districtStats[street.district].streets += 1;
            });

            return districtStats;
          };

          const openInGoogleMaps = (address) => {
            const encodedAddress = encodeURIComponent(address);
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
          };

          const openDistrictInGoogleMaps = (district) => {
            const query = `新北市${district}`;
            const encodedQuery = encodeURIComponent(query);
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodedQuery}`, '_blank');
          };

          if (loading) {
            return (
              <div className="flex items-center justify-center h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                <div className="text-center bg-white rounded-2xl shadow-2xl p-8 max-w-md">
                  <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto"></div>
                  <p className="mt-4 text-gray-700 text-lg font-medium">載入地址資料中...</p>
                  <p className="mt-2 text-gray-500 text-sm">正在從 Google Sheets 讀取資料</p>
                </div>
              </div>
            );
          }

          if (loadError) {
            return (
              <div className="flex items-center justify-center h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                <div className="text-center bg-white rounded-2xl shadow-2xl p-8 max-w-md">
                  <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <X className="w-8 h-8 text-red-600" />
                  </div>
                  <h2 className="text-xl font-bold text-gray-900 mb-2">載入失敗</h2>
                  <p className="text-gray-600 mb-4">無法從 Google Sheets 讀取資料</p>
                  <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                    <p className="text-sm text-red-800 font-mono">{loadError}</p>
                  </div>
                  <button
                    onClick={loadData}
                    className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                  >
                    重新載入
                  </button>
                  <div className="mt-4 text-left bg-blue-50 rounded-lg p-4">
                    <p className="text-sm text-gray-700 font-semibold mb-2">💡 解決方法：</p>
                    <ul className="text-sm text-gray-600 space-y-1 list-disc list-inside">
                      <li>確認 Google Sheets 已設為「知道連結的任何人」可檢視</li>
                      <li>檢查網路連線是否正常</li>
                      <li>嘗試重新整理頁面（F5）</li>
                    </ul>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
              {/* Header */}
              <div className="bg-white shadow-lg">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <Navigation className="w-8 h-8 text-indigo-600" />
                      <h1 className="text-3xl font-bold text-gray-900">地址路線規劃系統</h1>
                    </div>
                    <div className="flex space-x-2">
                      <button
                        onClick={() => setView('overview')}
                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                          view === 'overview'
                            ? 'bg-indigo-600 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        <BarChart3 className="w-5 h-5 inline mr-2" />
                        總覽
                      </button>
                      <button
                        onClick={() => setView('map')}
                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                          view === 'map'
                            ? 'bg-indigo-600 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                        disabled={selectedStreets.length === 0}
                      >
                        <MapPin className="w-5 h-5 inline mr-2" />
                        地圖檢視
                      </button>
                      <button
                        onClick={() => setView('route')}
                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                          view === 'route'
                            ? 'bg-indigo-600 text-white'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                        disabled={routeDays.length === 0}
                      >
                        <Calendar className="w-5 h-5 inline mr-2" />
                        路線規劃
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              {/* Stats Bar */}
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div className="bg-white rounded-xl shadow-md p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">總地址數</p>
                        <p className="text-2xl font-bold text-gray-900">{allData.length}</p>
                      </div>
                      <MapPin className="w-10 h-10 text-blue-500" />
                    </div>
                  </div>
                  <div className="bg-white rounded-xl shadow-md p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">街道總數</p>
                        <p className="text-2xl font-bold text-gray-900">{streetData.length}</p>
                      </div>
                      <List className="w-10 h-10 text-green-500" />
                    </div>
                  </div>
                  <div className="bg-white rounded-xl shadow-md p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">已選擇街道</p>
                        <p className="text-2xl font-bold text-indigo-600">{selectedStreets.length}</p>
                      </div>
                      <Check className="w-10 h-10 text-indigo-500" />
                    </div>
                  </div>
                  <div className="bg-white rounded-xl shadow-md p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">已選地址數</p>
                        <p className="text-2xl font-bold text-indigo-600">{getTotalSelected()}</p>
                      </div>
                      <Navigation className="w-10 h-10 text-purple-500" />
                    </div>
                  </div>
                </div>
              </div>

              {/* Main Content */}
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
                {view === 'overview' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <h2 className="text-xl font-bold text-gray-900 mb-4">選擇高密度區域</h2>
                      <div className="flex items-center space-x-4 mb-4">
                        <label className="text-gray-700 font-medium">規劃天數：</label>
                        <input
                          id="dayCount"
                          type="number"
                          min="1"
                          max="10"
                          defaultValue="3"
                          className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        />
                        <button
                          onClick={generateRoute}
                          disabled={selectedStreets.length === 0}
                          className={`px-6 py-2 rounded-lg font-medium transition-all ${
                            selectedStreets.length === 0
                              ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                              : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md hover:shadow-lg'
                          }`}
                        >
                          生成路線規劃
                        </button>
                        {selectedStreets.length > 0 && (
                          <button
                            onClick={() => setSelectedStreets([])}
                            className="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors"
                          >
                            清除選擇
                          </button>
                        )}
                      </div>
                      <p className="text-sm text-gray-500">
                        點擊下方街道卡片來選擇要拜訪的區域。選擇完成後可以在地圖檢視中查看分布情況。
                      </p>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <h2 className="text-xl font-bold text-gray-900 mb-4">
                        街道密集度排名（前50名）
                      </h2>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {streetData.slice(0, 50).map((street, index) => (
                          <div
                            key={street.id}
                            onClick={() => toggleStreet(street.id)}
                            className={`cursor-pointer rounded-lg border-2 p-4 transition-all hover:shadow-lg ${
                              selectedStreets.includes(street.id)
                                ? 'border-indigo-500 bg-indigo-50 shadow-md'
                                : 'border-gray-200 bg-white hover:border-indigo-300'
                            }`}
                          >
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center space-x-2 mb-2">
                                  <span className="text-lg font-bold text-gray-400">#{index + 1}</span>
                                  {selectedStreets.includes(street.id) && (
                                    <Check className="w-5 h-5 text-indigo-600" />
                                  )}
                                </div>
                                <h3 className="font-bold text-gray-900 mb-1">{street.name}</h3>
                                <p className="text-sm text-gray-600 mb-2">{street.district}</p>
                                <div className="flex items-center space-x-2">
                                  <MapPin className="w-4 h-4 text-indigo-500" />
                                  <span className="text-lg font-bold text-indigo-600">
                                    {street.count} 個地址
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {view === 'map' && selectedStreets.length > 0 && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <h2 className="text-2xl font-bold text-gray-900 mb-4">地圖檢視 - 區域分布</h2>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        {Object.entries(getDistrictInfo()).map(([district, info]) => (
                          <div key={district} className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-4 border-2 border-indigo-200">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="font-bold text-gray-900 text-lg">{district}</h3>
                              <button
                                onClick={() => openDistrictInGoogleMaps(district)}
                                className="px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition-colors flex items-center space-x-1"
                              >
                                <MapPin className="w-4 h-4" />
                                <span>開啟地圖</span>
                              </button>
                            </div>
                            <div className="space-y-1">
                              <p className="text-sm text-gray-600">街道數：<span className="font-semibold text-indigo-600">{info.streets}</span></p>
                              <p className="text-sm text-gray-600">地址數：<span className="font-semibold text-indigo-600">{info.count}</span></p>
                            </div>
                          </div>
                        ))}
                      </div>

                      <h3 className="text-xl font-bold text-gray-900 mb-4">已選擇的街道</h3>
                      <div className="space-y-3">
                        {streetData.filter(s => selectedStreets.includes(s.id)).map((street) => (
                          <div key={street.id} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div className="flex items-center justify-between mb-3">
                              <div>
                                <h4 className="font-bold text-gray-900">{street.name}</h4>
                                <p className="text-sm text-gray-600">{street.district} • {street.count} 個地址</p>
                              </div>
                              <button
                                onClick={() => openInGoogleMaps(`${street.district}${street.name}`)}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
                              >
                                <MapPin className="w-4 h-4" />
                                <span>在 Google 地圖中查看</span>
                              </button>
                            </div>
                            
                            <details className="mt-2">
                              <summary className="cursor-pointer font-medium text-indigo-600 hover:text-indigo-700 text-sm">
                                查看所有地址 ({street.addresses.length})
                              </summary>
                              <div className="mt-3 space-y-2 max-h-60 overflow-y-auto">
                                {street.addresses.map((addr, addrIndex) => (
                                  <div key={addrIndex} className="flex items-center justify-between text-sm border-b border-gray-200 pb-2">
                                    <div>
                                      <p className="font-medium text-gray-800">{addr['姓名']}</p>
                                      <p className="text-gray-600">{addr['地址']}</p>
                                    </div>
                                    <button
                                      onClick={() => openInGoogleMaps(addr['地址'])}
                                      className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 transition-colors flex items-center space-x-1"
                                    >
                                      <MapPin className="w-3 h-3" />
                                      <span>導航</span>
                                    </button>
                                  </div>
                                ))}
                              </div>
                            </details>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {view === 'route' && routeDays.length > 0 && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow-lg p-6">
                      <h2 className="text-2xl font-bold text-gray-900 mb-2">
                        {routeDays.length} 天路線規劃
                      </h2>
                      <p className="text-gray-600 mb-4">
                        總計 {getTotalSelected()} 個地址，分配到 {routeDays.length} 天完成
                      </p>
                    </div>

                    {routeDays.map((day, dayIndex) => {
                      const dayTotal = day.reduce((sum, s) => sum + s.count, 0);
                      const dayDistricts = [...new Set(day.map(s => s.district))];
                      
                      return (
                        <div key={dayIndex} className="bg-white rounded-xl shadow-lg overflow-hidden">
                          <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                            <div className="flex items-center justify-between">
                              <h3 className="text-xl font-bold text-white flex items-center">
                                <Calendar className="w-6 h-6 mr-2" />
                                第 {dayIndex + 1} 天
                              </h3>
                              <div className="text-right">
                                <p className="text-indigo-100 text-sm">涵蓋區域：{dayDistricts.join('、')}</p>
                                <p className="text-white font-bold">{dayTotal} 個地址</p>
                              </div>
                            </div>
                          </div>
                          <div className="p-6 space-y-4">
                            {day.map((street, streetIndex) => (
                              <div key={streetIndex} className="border-l-4 border-indigo-500 pl-4 py-2 bg-gray-50 rounded-r-lg">
                                <div className="flex items-center justify-between mb-2">
                                  <div className="flex items-center space-x-3">
                                    <span className="text-2xl font-bold text-indigo-600">#{streetIndex + 1}</span>
                                    <div>
                                      <h4 className="font-bold text-gray-900">{street.name}</h4>
                                      <p className="text-sm text-gray-600">{street.district}</p>
                                    </div>
                                  </div>
                                  <div className="flex items-center space-x-2">
                                    <span className="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-medium">
                                      {street.count} 個地址
                                    </span>
                                    <button
                                      onClick={() => openInGoogleMaps(`${street.district}${street.name}`)}
                                      className="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-1"
                                    >
                                      <MapPin className="w-4 h-4" />
                                      <span>導航</span>
                                    </button>
                                  </div>
                                </div>
                                <details className="mt-3">
                                  <summary className="cursor-pointer font-medium text-indigo-600 hover:text-indigo-700">
                                    查看詳細地址清單（已按門牌號碼排序）
                                  </summary>
                                  <div className="mt-3 space-y-2 max-h-60 overflow-y-auto bg-white rounded-lg p-3">
                                    {street.addresses.map((addr, addrIndex) => (
                                      <div key={addrIndex} className="flex items-center justify-between text-sm border-b border-gray-200 pb-2">
                                        <div>
                                          <p className="font-medium text-gray-800">{addr['姓名']}</p>
                                          <p className="text-gray-600">{addr['地址']}</p>
                                        </div>
                                        <button
                                          onClick={() => openInGoogleMaps(addr['地址'])}
                                          className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 transition-colors flex items-center space-x-1 whitespace-nowrap"
                                        >
                                          <MapPin className="w-3 h-3" />
                                          <span>導航</span>
                                        </button>
                                      </div>
                                    ))}
                                  </div>
                                </details>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
          );
        };

        // 等待所有依賴載入完成後再渲染
        function waitForDependencies() {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Babel === 'undefined') {
                console.log('等待依賴載入...');
                setTimeout(waitForDependencies, 100);
                return;
            }
            
            console.log('所有依賴已載入，開始渲染應用程式');
            try {
                ReactDOM.render(<AddressRoutePlanner />, document.getElementById('root'));
            } catch (error) {
                console.error('渲染錯誤:', error);
                document.getElementById('root').innerHTML = `
                    <div style="padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 8px; margin: 20px;">
                        <h2 style="color: #c33;">渲染錯誤</h2>
                        <p>錯誤訊息: ${error.message}</p>
                        <p>請檢查瀏覽器控制台以獲取更多詳細資訊。</p>
                    </div>
                `;
            }
        }
        
        // 開始等待依賴
        waitForDependencies();
    </script>
</body>
</html>
